# 🎨 Nano Banana - AI 图像生成与编辑

**更新日志（最新）**

v1.1.6
- 生成流程：点击后立即显示“生成中”，改善交互响应。
- 比例保障：若最终成图与所选比例偏差超过阈值（约3%），自动重试一次（不做强制裁切）。

v1.1.5
- 修复：加入参考图仅使用干净底图（不叠加红框/标注），避免把标注带入生成。
- 修复：Prompt 加入“不要渲染标注、红框、箭头或文字”的硬性约束。
- 优化：去重重复的参考图，减少模型困惑。
- UI：继续保持工具栏自动换行，避免溢出。

v1.1.4
- 精简编辑器：移除吸附与标注导入/导出，工具栏更简洁，避免超出面板宽度。
- 布局修复：工具区支持自动换行，防止宽度溢出。

v1.1.3
- UI 贴近 Apple 设计：胶囊分段控制、圆角 chip、主/次按钮统一风格；更轻的投影与细腻的悬浮态。
- 图编辑增强：Option 拖拽复制、Shift 限制正方形/45° 方向。
- 性能：保持 rAF 合批与 HiDPI 渲染。

v1.1.2
- UI 优化：工具分组胶囊样式、按钮风格统一；参考图移至画布下方栅格展示。
- 标注增强：选中态高亮与控制点；矩形/圆角点缩放；箭头端点拖动；文字可移动。
- 撤销/重做：工具栏按钮 + 快捷键（Ctrl/Cmd+Z 撤销；Ctrl/Cmd+Shift+Z 或 Ctrl/Cmd+Y 重做）。
- 删除选中：提供按钮与 Delete/Backspace 快捷键。
- 更换编辑图：随时替换，自动清空标注并保留参考图。
- 性能与精度：Pointer Events、HiDPI、rAF 合批、ImageBitmap 缓存，指针更精确、绘制更流畅。

一个现代化的 AI 图像生成 Web 应用，支持文生图、图生图，以及全新的「图编辑」工作流（可标注矩形/圆/箭头/文字来指导模型布局/放置）。

## ✨ 更新概览（v1.1.1）

- 🧩 前端脚本模块化：将原 `script.js` 拆分为多文件，便于 Debug 与维护。
- 🖍️ 新增/强化「图编辑」：
  - 上传编辑图并可随时「更换编辑图」。
  - 支持矩形、圆形、箭头、文字工具；颜色与标签可选。
  - 标注可直接拖动移动，无需重画。
  - 参考图移至画布下方，支持多图预览与删除。
  - 更小的默认画布尺寸，避免占满页面。
  - Prompt 注入标注的归一化几何信息，强化布局与放置指导；明确不渲染标注到最终图。
- 🔁 生成重试更智能：指数退避 + 抖动，失败提示更清晰。
- 🛡️ API/代理更安全：
  - 所有 API 响应带 CORS 头，支持可选 `ALLOWED_ORIGINS` 白名单。
  - 图片代理仅允许配置的 GitHub 仓库（`ALLOWED_REPOS`），避免开放代理风险。
- ⚡ 前端优化：
  - 图片 `decoding="async"`、非阻塞通知、懒加载与缓存优化。

## 📁 代码结构

- `index.html`：主页面，增加了「图编辑」面板与脚本引用顺序。
- `style.css`：样式（复用原有组件样式）。
- `prompts.js`：灵感提示词模板。
- `db.js`：IndexedDB 封装（历史、收藏、图片缓存）。
- `utils.js`：通用工具（通知、比例选择、图片代理/缓存）。
- `gallery.js`：灵感画廊、预览与灯箱。
- `uploads.js`：图生图上传与“发送到图生图”。
- `historyFavorites.js`：收藏与历史记录（渲染、删除、导出）。
- `settings.js`：主题切换、模型预设、API 测试与保存。
- `editor.js`：图编辑（矩形标注、参考图管理、导出到参考图）。
- `generate.js`：统一生成入口（文生图/图生图/图编辑）。
- `app.js`：应用启动、Tab 切换、模态框、结果区域事件委托、清理等。
- `functions/api/generate.js`：服务端生成代理（Cloudflare Pages Functions）。
- `functions/api/proxy-image.js`：图片代理，仓库白名单与 CORS。

> 说明：原 `script.js` 已被拆分为上述多个模块文件，`index.html` 不再加载 `script.js`。

## 🧭 使用指南

1. 文生图
   - 切换到「文生图」，输入提示词，选择图片比例，点击「生成」。
2. 图生图
   - 切换到「图生图」，上传参考图（支持拖拽/多图），输入提示词，选择比例，点击「生成」。
3. 图编辑（新增）
   - 切换到「图编辑」。
   - 上传“编辑图”（画布区域），在画布上选择工具绘制：矩形 / 圆形 / 箭头 / 文字；可设置颜色与标签。
   - 将鼠标移到标注上（光标变为移动形态）可拖动标注；箭头整体可移动。
   - 可继续上传多张“参考图”（画布下方缩略图区域，可删除）。
   - 「更换编辑图」可随时替换编辑图；「加入参考图」将当前编辑结果加入参考图。
   - 编写提示词，例如：
     - “把苹果放在我画的红框中，保持真实光影和透视。”
   - 选择比例，点击「生成」。系统会：
     - 将矩形标注转换为结构化文字说明（包含像素和归一化坐标）。
     - 将编辑后的图片与参考图一起作为多模态输入，必要时附带一张“比例画布”以强化宽高比约束。

## 🔧 部署与配置

建议部署到 Cloudflare Pages。

必填环境变量：
- `VELAO_API_KEY`：后端转发到 `https://veloe.onrender.com/v1/chat/completions` 所需的 API Key。

可选环境变量：
- `ALLOWED_ORIGINS`：允许访问 API 的前端来源（逗号分隔）。默认 `*`。
- `ALLOWED_REPOS`：图片代理允许的 GitHub 仓库（逗号分隔）。若未配置则使用内置白名单：
  - `PicoTrex/Awesome-Nano-Banana-images`
  - `songguoxs/gpt4o-image-prompts`
  - `jamez-bondos/awesome-gpt4o-images`

API 端点：
- `/api/generate` - 生成图片
- `/api/proxy-image` - 图片代理（只允许指定域与仓库）

## 🧪 调试与开发建议

- 模块边界清晰：
  - UI/交互：`app.js`、`gallery.js`、`settings.js`、`editor.js`
  - 生成流程：`generate.js`
  - 数据持久化：`db.js` + `historyFavorites.js`
  - 工具：`utils.js`（比例、图片代理/缓存、通知）
- 日志：生成过程里会输出请求体（已截断图片数据），并提供详细错误信息与可展开的 Debug 面板。

## 📱 移动端与性能

- 响应式适配（栅格布局、内容折叠）。
- 图片懒加载 + 缓存（IndexedDB），减少网络与内存压力。
- 预览器和灯箱对移动端自动禁用悬浮行为。

## ⚠️ 注意事项

- 图编辑标注仅作为“布局意图”的强提示，具体落地依赖模型能力与输入提示质量。
- 若模型返回纯文本而非图片，系统会自动重试（最多 3 次），并给出优化提示。

---

Powered by Nano Banana Team
